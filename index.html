<!doctype html>
<html class="no-js" lang="fr">

  <head>
    <!-- meta data -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->

    <!--font-family-->
    <link href="https://fonts.googleapis.com/css?family=Poppins:100,200,300,400,500,600,700,800,900&amp;subset=devanagari,latin-ext" rel="stylesheet">

    <!-- title of site -->
    <title>MIGRATIONS</title>

    <!-- For favicon png -->
    <link rel="shortcut icon" type="image/icon" href="assets/logo/favicon.png"/>

    <!--font-awesome.min.css-->
    <link rel="stylesheet" href="assets/css/font-awesome.min.css">

    <!--flat icon css-->
    <link rel="stylesheet" href="assets/css/flaticon.css">

    <!--animate.css-->
    <link rel="stylesheet" href="assets/css/animate.css">

    <!--owl.carousel.css-->
    <link rel="stylesheet" href="assets/css/owl.carousel.min.css">
    <link rel="stylesheet" href="assets/css/owl.theme.default.min.css">

    <!--bootstrap.min.css-->
    <link rel="stylesheet" href="assets/css/bootstrap.min.css">

    <!-- bootsnav -->
    <link rel="stylesheet" href="assets/css/bootsnav.css" >

    <!--style.css-->
    <link rel="stylesheet" href="assets/css/style.css">

    <!--responsive.css-->
    <link rel="stylesheet" href="assets/css/responsive.css">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->

    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

  </head>

  <body>
    <!--[if lte IE 9]>
      <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
    <![endif]-->

    <!-- top-area Start -->
    <header class="top-area">
      <div class="header-area">
        <!-- Start Navigation -->
        <nav class="navbar navbar-default bootsnav navbar-fixed dark no-background">

          <div class="container">

            <!-- Start Header Navigation -->
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-menu">
                <i class="fa fa-bars"></i>
              </button>
              <a class="navbar-brand" href="index.html">MIGRATIONS</a>
            </div><!--/.navbar-header-->
            <!-- End Header Navigation -->

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse menu-ui-design" id="navbar-menu">
              <ul class="nav navbar-nav navbar-right" data-in="fadeInDown" data-out="fadeOutUp">
              <li class=" smooth-menu active"></li>
                <li class=" smooth-menu"><a href="#mbc_section">Migrations par pays</a></li>
                <li class="smooth-menu"><a href="#mbcn_section">Migrations par pays normalisées</a></li>
                <li class="smooth-menu"><a href="#mahdi_section">Migrations et IDH</a></li>
                <li class="smooth-menu"><a href="#magii_section">Migrations et IIG</a></li>
                <li class="smooth-menu"><a href="#mau_section">Migrations et chômage</a></li>
              </ul><!--/.nav -->
            </div><!-- /.navbar-collapse -->
          </div><!--/.container-->
        </nav><!--/nav-->
        <!-- End Navigation -->
      </div><!--/.header-area-->

      <div class="clearfix"></div>

    </header><!-- /.top-area-->
    <!-- top-area End -->

    <!-- empty space under navbar starts -->
    <section id="empty" style="height:90px;">
    </section>
    <!-- empty space under navbar ends -->

    <!-- migrations by country starts -->
    <section id="mbc_section" class="main_map">
      <div class="section-heading text-center">
        <h2>Flux migratoires par pays</h2>
      </div>
      <div class="container">
        <div class="main_map-content">
          <div class="row">
            <!-- column with the map -->
            <div class="col-sm-9">
              <div id="map_div_mbc">
              </div>
            </div>

            <!-- column with the information -->
            <div class="col-sm-3">
              <div class="row">
                <div class="slidecontainer">
                  <input type="range" min="0" max="6" value="2"
                          step="1" class="slider" id="myRange">
                  <p>Année : <span id="demo"></span></p>
                </div>
              </div>
              <div class="row">
                <div id="top10container" class="top10container">
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- migrations by country ends -->

    <!--migrations by country normalised starts -->
    <section id="mbcn_section" class="main_map">
      <div class="section-heading text-center">
        <h2>Flux migratoires par pays (normalisé par le nombre d'habitants du pays de déstination)</h2>
      </div>
      <div class="container">
        <div class="main_map-content">
          <div class="row">
            <!-- column with the map -->
            <div class="col-sm-9">
              <div id="map_div_mbcn">
              </div>
            </div>

            <!-- column with the information -->
            <div class="col-sm-3">
              <div class="row">
                <div class="slidecontainer">
                  <input type="range" min="0" max="6"
                          value="2" step="1" class="slider"
                          id="myRange_norm">
                  <p>Année : <span id="demo_norm"></span></p>
                </div>
              </div>
              <div class="row">
                <div id="norm_top10container" class="top10container">
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!--migrations by country normalised ends -->

    <!--migrations and hdi starts -->
    <section id="mahdi_section" class="main_scatter">
      <div class="section-heading text-center">
        <h2>Flux migratoires et IDH</h2>
      </div>
      <div class="container">
        <div class="main_scatter-content">
          <div class="row">
            <!-- column with the scatterplot -->
            <div class="col-sm-8">
              <div id="scatter_div_hdi">
              </div>
            </div>

            <!-- column with the map -->
            <div class="col-sm-4">
              <div id="map_div_hdi">
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!--migrations and hdi ends -->

    <!-- migrations and gii starts -->
    <section id="magii_section" class="main_scatter">
      <div class="section-heading text-center">
        <h2>Flux migratoires et IIG</h2>
      </div>
      <div class="container">
        <div class="main_scatter-content">
          <div class="row">
            <!-- column with the scatterplot -->
            <div class="col-sm-8">
              <div id="scatter_div_gii">
              </div>
            </div>

            <!-- column with the map -->
            <div class="col-sm-4">
              <div id="map_div_gii">
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!--migrations and gii ends -->

    <!--migrations and unemployment starts -->
    <section id="mau_section" class="main_scatter">
      <div class="section-heading text-center">
        <h2>Flux migratoires et chômage</h2>
      </div>
      <div class="container">
        <div class="main_scatter-content">
          <div class="row">
            <!-- column with the scatterplot -->
            <div class="col-sm-8">
              <div id="scatter_div_unemp">
              </div>
            </div>

            <!-- column with the map -->
            <div class="col-sm-4">
              <div id="map_div_unemp">
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- migrations and unemployment ends -->

    <!--footer-copyright start-->
    <footer id="footer-copyright" class="footer-copyright">
      <div class="container">
        <div class="hm-footer-copyright text-center">
          <p>
            &copy; copyright MIGRATIONS. design and developed by <a href="https://www.themesine.com/">themesine</a>
          </p><!--/p-->
        </div><!--/.text-center-->
      </div><!--/.container-->

      <div id="scroll-Top">
        <div class="return-to-top">
          <i class="fa fa-angle-up " id="scroll-top" ></i>
        </div>

      </div><!--/.scroll-Top-->

    </footer><!--/.footer-copyright-->
    <!--footer-copyright end-->

    <!-- Include all js compiled plugins (below), or include individual files as needed -->

    <script src="assets/js/jquery.js"></script>

    <!--modernizr.min.js-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"></script>
    <!--
    <script src="no_internet/modernizr.min.js"></script>
    -->

    <!--bootstrap.min.js-->
    <script src="assets/js/bootstrap.min.js"></script>

    <!-- bootsnav js -->
    <script src="assets/js/bootsnav.js"></script>

    <!-- jquery.sticky.js -->
    <script src="assets/js/jquery.sticky.js"></script>

    <!-- for progress bar start-->

    <!-- progressbar js -->
    <script src="assets/js/progressbar.js"></script>

    <!-- appear js -->
    <script src="assets/js/jquery.appear.js"></script>

    <!-- for progress bar end -->

    <!--owl.carousel.js-->
    <script src="assets/js/owl.carousel.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.4.1/jquery.easing.min.js"></script>
    <!--
    <script src="no_internet/jquery.easing.min.js"></script>
    -->

    <!--Custom JS-->
    <script type="text/javascript" src="assets/js/custom.js"></script>

    <!-- D3 tools -->
    <script type="text/javascript" src="https://d3js.org/d3.v4.min.js"></script>
    <script type="text/javascript" src="https://d3js.org/queue.v1.min.js"></script>
    <script type="text/javascript" src="https://d3js.org/topojson.v1.min.js"></script>
    <!--
    <script type="text/javascript" src="no_internet/d3.v4.min.js"></script>
    <script type="text/javascript" src="no_internet/queue.v1.min.js"></script>
    <script type="text/javascript" src="no_internet/topojson.v1.min.js"></script>
    -->

    <!-- create map -->
    <script type="text/javascript">
      var formatTime = d3.timeFormat("%Y");
      var parseDate = d3.timeParse("%Y");
      var integerFormat = d3.format(".0f");
      var percentageFormat = d3.format(".4%");
      var years = [];

      var margin = {top: 20, right: 20, bottom: 30, left: 40};

      var width_main_scatter = 800 - margin.left - margin.right,
          height_main_scatter = 500 - margin.top - margin.bottom;
      var width_main_map = 900 - margin.left - margin.right,
          height_main_map = 600 - margin.top - margin.bottom;
      var width_little_map = 420 - margin.left - margin.right,
          height_little_map = 350 - margin.top - margin.bottom;
      var width_top10 = 320 - margin.left - margin.right,
          height_top10 = 500 - margin.top - margin.bottom;

      var clicked_country;
      var data_country;

      //scatterplot scales and axes
      var x_hdi = d3.scaleLinear()
        .range([0, width_main_scatter]);
      var y_hdi = d3.scaleTime()
        .range([height_main_scatter, 0]);
      var r_hdi = d3.scaleSqrt()
        .range([2,15]);
      var xAxis_hdi = d3.axisBottom()
        .scale(x_hdi);
      var yAxis_hdi = d3.axisLeft()
        .scale(y_hdi);

      var x_gii = d3.scaleLinear()
      .range([0, width_main_scatter]);
      var y_gii = d3.scaleTime()
      .range([height_main_scatter, 0]);
      var r_gii = d3.scaleSqrt()
      .range([1,15]);
      var xAxis_gii = d3.axisBottom()
      .scale(x_gii);
      var yAxis_gii = d3.axisLeft()
      .scale(y_gii);

      var x_unemp = d3.scaleLinear()
        .range([0, width_main_scatter]);
      var y_unemp = d3.scaleTime()
        .range([height_main_scatter, 0]);
      var r_unemp = d3.scaleSqrt()
      .range([1,17]);
      var xAxis_unemp = d3.axisBottom()
        .scale(x_unemp);
      var yAxis_unemp = d3.axisLeft()
        .scale(y_unemp);

      var color_scatter = d3.scaleOrdinal(d3.schemeCategory20);

      var path = d3.geoPath();

      //adding svg images to the site

      var svg_map_mbc = d3.select("#map_div_mbc")
                  .append("svg")
                  .attr("width", width_main_map)
                  .attr("height", height_main_map)
                  .append('g')
                  .attr('class', 'map');

      var svg_map_mbcn = d3.select("#map_div_mbcn")
                  .append("svg")
                  .attr("width", width_main_map)
                  .attr("height", height_main_map)
                  .append('g')
                  .attr('class', 'map');

      var svg_scatter_hdi = d3.select("#scatter_div_hdi")
                  .append("svg")
                  .attr("width", width_main_scatter + margin.left + margin.right)
                  .attr("height", height_main_scatter + margin.top + margin.bottom)
                  .append("g")
                  .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      var svg_map_hdi = d3.select("#map_div_hdi")
                  .append("svg")
                  .attr("width", width_little_map)
                  .attr("height", height_little_map)
                  .append('g')
                  .attr('class', 'little_map');

      var svg_scatter_gii = d3.select("#scatter_div_gii")
                  .append("svg")
                  .attr("width", width_main_scatter + margin.left + margin.right)
                  .attr("height", height_main_scatter + margin.top + margin.bottom)
                  .append("g")
                  .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      var svg_map_gii = d3.select("#map_div_gii")
                  .append("svg")
                  .attr("width", width_little_map)
                  .attr("height", height_little_map)
                  .append('g')
                  .attr('class', 'little_map');

      var svg_scatter_unemp = d3.select("#scatter_div_unemp")
                  .append("svg")
                  .attr("width", width_main_scatter + margin.left + margin.right)
                  .attr("height", height_main_scatter + margin.top + margin.bottom)
                  .append("g")
                  .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      var svg_map_unemp = d3.select("#map_div_unemp")
                  .append("svg")
                  .attr("width", width_little_map)
                  .attr("height", height_little_map)
                  .append('g')
                  .attr('class', 'little_map');

      var main_projection = d3.geoNaturalEarth1()
                         .scale(180)
                        .translate( [width_main_map / 2, height_main_map / 2]);

      var little_projection = d3.geoNaturalEarth1()
                         .scale(75)
                        .translate( [width_little_map / 2, height_little_map / 2]);

      var main_path = d3.geoPath().projection(main_projection),
          little_path = d3.geoPath().projection(little_projection);

      //list of files
      queue()
        .defer(d3.json, 'data/world_countries.json')
        .defer(d3.csv, 'data/migration_idh_div.csv')
        .defer(d3.csv, 'data/migration_chomage_div.csv')
        .defer(d3.csv, 'data/migration_iig_div.csv')
        .defer(d3.csv, 'data/origindestine_avec_id_et_poptotale.csv')
        .await(ready);

      function ready(
                      error, map_data,
                      hdi_data,
                      unemp_data, gii_data,
                      data_migration
                    )
      {

        //data pre-processing
        var max_pop_idh = 0;
        var min_pop_idh = Infinity;
        hdi_data.forEach(
          function(d)
          {
            d.idh = +d.idh;
            d.date = parseDate(d.date);
            d.pop = +d.pop;

            if (d.pop > max_pop_idh)
              max_pop_idh = d.pop;

            if (d.pop < min_pop_idh)
              min_pop_idh = d.pop;
          }
        );

        var max_pop_gii = 0;
        var min_pop_gii = Infinity;
        gii_data.forEach(
          function(d)
          {
            d.iig = +d.iig;
            d.date = parseDate(d.date);
            d.pop = +d.pop;

            if (d.pop > max_pop_gii)
              max_pop_gii = d.pop;

            if (d.pop < min_pop_gii)
              min_pop_gii = d.pop;
          }
        );

        var max_pop_unemp = 0;
        var min_pop_unemp = Infinity;
        unemp_data.forEach(
          function(d)
          {
            d.chomage = +d.chomage;
            d.date = parseDate(d.date);
            d.pop = +d.pop;

            if (d.pop > max_pop_unemp)
              max_pop_unemp = d.pop;

            if (d.pop < min_pop_unemp)
              min_pop_unemp = d.pop;
          }
        );

        data_migration.forEach(
          function(d)
          {
            if (!years.includes(d.year))
              years.push(d.year);
            d.migrant_stock = +d.migrant_stock;
            d.pop_destination = +d.pop_destination;
            d.long_o = +d.long_o;
            d.lat_o = +d.lat_o;
            d.long_d = +d.long_d;
            d.lat_d = +d.lat_d;
          }
        );

        var slider = document.getElementById("myRange");
        var output = document.getElementById("demo");
        output.innerHTML = slider.value;

        slider.oninput = function()
                        {
                          output.innerHTML = years[this.value];
                        };
        slider.oninput();
        slider.onchange = function()
                          {
                            let current_year = this.value;
                            let data_by_year = data_migration
                              .filter(function(mig)
                                      {
                                        return (mig.year == years[current_year])
                                      }
                                    );

                            year_opacity(this.value, data_by_year, svg_map_mbc, migration_lines);
                            if(typeof data_country != 'undefined' && data_country != '')
                            {
                              let filtered_data = data_by_year
                                .filter(function(mig)
                                        {
                                          return (mig.id_destination == data_country.id)
                                        }
                                      )
                                .sort(function(s, w)
                                {
                                  return w.migrant_stock - s.migrant_stock
                                }
                              )
                                .slice(0, 10);
                              update_top10(data_country, clicked_country, filtered_data);
                            }
                          };

        var slider_norm = document.getElementById("myRange_norm");
        var output_norm = document.getElementById("demo_norm");
        output_norm.innerHTML = slider_norm.value;

        slider_norm.oninput = function()
                              {
                                output_norm.innerHTML = years[this.value];
                              };
        slider_norm.oninput();
        slider_norm.onchange = function()
                                {
                                  let current_year = this.value;
                                  let data_by_year = data_migration
                                    .filter(function(mig)
                                            {
                                              return (mig.year == years[current_year])
                                            }
                                          );

                                  year_opacity(this.value, data_by_year,
                                                svg_map_mbcn, norm_migration_lines);
                                  if(typeof data_country != 'undefined' && data_country != '')
                                  {
                                    let filtered_data = data_by_year
                                      .filter(function(mig)
                                              {
                                                return (mig.id_destination == data_country.id)
                                              }
                                            )
                                      .sort(function(s, w)
                                            {
                                              return w.migrant_stock - s.migrant_stock
                                            }
                                          )
                                      .slice(0, 10);
                                    update_top10(data_country, clicked_country, false, filtered_data);
                                  }

                                };

        var Tooltip_hdi = d3.select("#scatter_div_hdi")
          .append("div")
          .style("opacity", 0)
          .attr("class", "tooltip_scatter")
          .style("background-color", "white")
          .style("border", "solid")
          .style("border-width", "2px")
          .style("border-radius", "5px")
          .style("padding", "5px");

        var Tooltip_gii = d3.select("#scatter_div_gii")
          .append("div")
          .style("opacity", 0)
          .attr("class", "tooltip_scatter")
          .style("background-color", "white")
          .style("border", "solid")
          .style("border-width", "2px")
          .style("border-radius", "5px")
          .style("padding", "5px");

        var Tooltip_unemp = d3.select("#scatter_div_unemp")
          .append("div")
          .style("opacity", 0)
          .attr("class", "tooltip_scatter")
          .style("background-color", "white")
          .style("border", "solid")
          .style("border-width", "2px")
          .style("border-radius", "5px")
          .style("padding", "5px");

        //responsive functions
        var mouseover = function(d, tooltip, circle)
                        {
                          tooltip
                            .style("opacity", 1);
                          if (d3.select(circle).attr('clicked') == 'true')
                          {
                            d3.select(circle)
                              .style("stroke", "black")
                              .style("opacity", 1);
                          }
                        };

        var mousemove = function(d, tooltip, circle, tooltip_text)
                        {
                          tooltip
                            .html(tooltip_text)
                            .style("left", (d3.mouse(circle)[0]+70) + "px")
                            .style("top", (d3.mouse(circle)[1]) + "px")
                        };

        var mouseleave = function(d, tooltip, circle)
                        {
                          tooltip
                            .style("opacity", 0)
                          if (d3.select(circle).attr('clicked') == 'true')
                          {
                            d3.select(circle)
                              .style("stroke", "none")
                              .style("opacity", 0.8)
                          }
                        };

        var over_country = function(d, country)
                            {
                              d3.select(country)
                                .style("opacity", 1)
                                .style("fill", "#e00000");
                            };

        var leave_country = function(d, country)
                            {
                              if (d3.select(country).attr("clicked") !== 'true')
                              {
                                d3.select(country)
                                  .style("opacity", 0.8)
                                  .style("fill", "rgb(33, 113, 181)");
                              }
                            };

        var migration_lines = function(d){return (d.migrant_stock * 0.0000004);}
        var norm_migration_lines = function(d){return ((d.migrant_stock / d.pop_destination) * 10)}

        x_hdi.domain([-0.01, 1]);
        y_hdi.domain([new Date(1987,0,1), new Date(2022,0,1)])
        r_hdi.domain(d3.extent(hdi_data, function(d){return d.idh;}))
            .nice();

        x_gii.domain([-0.01, 0.7]);
        y_gii.domain([new Date(1987,0,1), new Date(2022,0,1)])
        r_gii.domain(d3.extent(gii_data, function(d){return d.iig;}))
            .nice();

        x_unemp.domain([-0.01, 1]);
        y_unemp.domain([new Date(1987,0,1), new Date(2022,0,1)])
        r_unemp.domain(d3.extent(unemp_data, function(d){return d.chomage;}))
            .nice();

        //filling svgs
        svg_map_mbc
          .append('rect')
          .attr("width", width_main_map)
          .attr("height", height_main_map)
          .attr('fill', 'white');

        svg_map_mbc.append('g')
        .attr('class', 'countries')
        .selectAll('path')
          .data(map_data.features)
          .enter().append('path')
            .attr('d', main_path)
            .style('fill', 'rgb(33, 113, 181)')
            .style('stroke', 'black')
            .style('opacity', 0.8)
            .style('stroke-width', 0.3)
            .attr('class', function(d){return 'country_object_' + d.id})
            .attr('type', 'main_map')
            .attr('clicked', 'false')
            .on('mouseover', function(d){return over_country(d, this);})
            .on('mouseleave', function(d){return leave_country(d, this);})
            .on('click', function(d)
                          {
                            data_country = d;
                            let filtered_original =
                                data_migration
                                  .filter(function(mig)
                                          {
                                            return (mig.id_destination == d.id &&
                                                    mig.year == years[slider.value])
                                          }
                                        )
                                  .sort(function(s, w)
                                        {
                                          return w.migrant_stock - s.migrant_stock
                                        }
                                      )
                                  .slice(0, 10);
                            let filtered_norm =
                                data_migration
                                  .filter(function(mig)
                                          {
                                            return (mig.id_destination == d.id &&
                                                    mig.year == years[slider_norm.value])
                                          }
                                        )
                                  .sort(function(s, w)
                                        {
                                          return w.migrant_stock - s.migrant_stock
                                        }
                                      )
                                  .slice(0, 10);
                            raise_country(d, this, filtered_original, filtered_norm);
                          }
                );

        svg_map_mbc.append('g')
          .attr('class', 'countries_migrations')
          .selectAll("path")
          .data(data_migration.filter(function(mig){return (mig.year == years[slider.value])}))
          .enter()
          .append("path")
          .attr("d", function(d)
                      {
                        var x = {
                                  type: "LineString",
                                  coordinates : [[d.long_o, d.lat_o], [d.long_d, d.lat_d]]
                                };
                        return main_path(x);
                      }
                )
          .style("fill", "none")
          .style("stroke", "#0e104b")
          .style("stroke-width", migration_lines);

        d3.select('#top10container')
          .html('<h3>Cliquez sur un pays pour obtenir des informations</h3>')

        svg_map_mbcn
          .append('rect')
          .attr("width", width_main_map)
          .attr("height", height_main_map)
          .attr('fill', 'white');

        svg_map_mbcn.append('g')
        .attr('class', 'countries')
        .selectAll('path')
          .data(map_data.features)
          .enter().append('path')
            .attr('d', main_path)
            .style('fill', 'rgb(33, 113, 181)')
            .style('stroke', 'black')
            .style('opacity', 0.8)
            .style('stroke-width', 0.3)
            .attr('class', function(d){return 'country_object_' + d.id})
            .attr('type', 'main_map')
            .attr('clicked', 'false');

        svg_map_mbcn.append('g')
          .attr('class', 'countries_migrations')
          .selectAll("path")
          .data(data_migration.filter(function(mig){return (mig.year == years[slider_norm.value])}))
          .enter()
          .append("path")
          .attr("d", function(d)
                      {
                        var x = {
                                  type: "LineString",
                                  coordinates : [[d.long_o, d.lat_o], [d.long_d, d.lat_d]]
                                };
                        return main_path(x);
                      }
                )
          .attr('name',  function(d){return d.origin + '_' + d.destination;})
          .style("fill", "none")
          .style("stroke", "#0e104b")
          .style("stroke-width", norm_migration_lines);

        svg_scatter_hdi.append('g')
          .attr('transform', 'translate(0,' + height_main_scatter + ')')
          .attr('class', 'x axis')
          .call(xAxis_hdi);

        svg_scatter_hdi.append('g')
          .attr('transform', 'translate(0,0)')
          .attr('class', 'y axis')
          .call(yAxis_hdi);

        svg_scatter_hdi.append('text')
          .attr('x', 10)
          .attr('y', 10)
          .attr('class', 'label')
          .text('Annee');

        svg_scatter_hdi.append('text')
          .attr('x', width_main_scatter)
          .attr('y', height_main_scatter - 10)
          .attr('text-anchor', 'end')
          .attr('class', 'label')
          .text('Nombre d\'immigrants \/ Nombre d\'habitants');

        svg_scatter_hdi.selectAll("circle")
          .data(hdi_data)
          .enter().append("circle")
          .attr('class', function(d){return 'country_object_' + d.id})
          .attr('clicked', 'false')
          .attr('type', 'main_scatter')
          .attr("r", function(d) { return r_hdi(d.idh); })
          .attr("cx", function(d) { return x_hdi(d.pop); })
          .attr("cy", function(d) { return y_hdi(d.date); })
          .style("fill", function(d) { return color_scatter(d.pays); })
          .on("mouseover", function(d){return mouseover(d, Tooltip_hdi, this);})
          .on("mouseleave", function(d){return mouseleave(d, Tooltip_hdi, this);})
          .on("mousemove", function(d)
                            {
                              return mousemove(
                                                d, Tooltip_hdi, this,
                                                d.pays + "</br>Pourcentage d'immigrant: " +
                                                d3.format(".1f")(d.pop * 100 ) +
                                                "%</br>IDH: " + d.idh
                                              );
                            }
              );

        svg_map_hdi.append('g')
          .attr('class', 'countries')
          .selectAll('path')
          .data(map_data.features)
          .enter().append('path')
            .attr('d', little_path)
            .style('fill', 'rgb(33, 113, 181)')
            .style('stroke', 'white')
            .style('opacity', 0.8)
            .style('stroke-width', 0.3)
            .attr('class', function(d){return 'country_object_' + d.id})
            .attr('type', 'little_map')
            .attr('clicked', 'false');

        svg_scatter_gii.append('g')
          .attr('transform', 'translate(0,' + height_main_scatter + ')')
          .attr('class', 'x axis')
          .call(xAxis_gii);

        svg_scatter_gii.append('g')
          .attr('transform', 'translate(0,0)')
          .attr('class', 'y axis')
          .call(yAxis_gii);

        svg_scatter_gii.append('text')
          .attr('x', 10)
          .attr('y', 10)
          .attr('class', 'label')
          .text('Annee');

        svg_scatter_gii.append('text')
          .attr('x', width_main_scatter)
          .attr('y', height_main_scatter - 10)
          .attr('text-anchor', 'end')
          .attr('class', 'label')
          .text('Nombre d\'émigrantes \/ Nombre d\'émigrants (Femme + Homme)');

        svg_scatter_gii.selectAll("circle")
          .data(gii_data)
          .enter().append("circle")
          .attr('class', function(d){return 'country_object_' + d.id})
          .attr('clicked', 'false')
          .attr('type', 'main_scatter')
          .attr("r", function(d) { return r_gii(d.iig); })
          .attr("cx", function(d) { return x_gii(d.pop); })
          .attr("cy", function(d) { return y_gii(d.date); })
          .style("fill", function(d) { return color_scatter(d.pays); })
          .on("mouseover", function(d){return mouseover(d, Tooltip_gii, this);})
          .on("mouseleave", function(d){return mouseleave(d, Tooltip_gii, this);})
          .on("mousemove", function(d)
                            {
                              return mousemove(
                                                d, Tooltip_gii, this,
                                                d.pays +
                                                "</br>Pourcentage de femme qui émigre: " +
                                                d3.format(".1f")(d.pop * 100 ) +
                                                "%</br>IIG: " + d.iig
                                              );
                            }
              );

        svg_map_gii.append('g')
          .attr('class', 'countries')
          .selectAll('path')
          .data(map_data.features)
          .enter().append('path')
            .attr('d', little_path)
            .style('fill', 'rgb(33, 113, 181)')
            .style('stroke', 'white')
            .style('opacity', 0.8)
            .style('stroke-width', 0.3)
            .attr('class', function(d){return 'country_object_' + d.id})
            .attr('type', 'little_map')
            .attr('clicked', 'false');

        svg_scatter_unemp.append('g')
          .attr('transform', 'translate(0,' + height_main_scatter + ')')
          .attr('class', 'x axis')
          .call(xAxis_unemp);

        svg_scatter_unemp.append('g')
          .attr('transform', 'translate(0,0)')
          .attr('class', 'y axis')
          .call(yAxis_unemp);

        svg_scatter_unemp.append('text')
          .attr('x', 10)
          .attr('y', 10)
          .attr('class', 'label')
          .text('Annee');

        svg_scatter_unemp.append('text')
          .attr('x', width_main_scatter)
          .attr('y', height_main_scatter - 10)
          .attr('text-anchor', 'end')
          .attr('class', 'label')
          .text('Nombre d\'émigrants \/ Nombre d\'habitants');

        svg_scatter_unemp.selectAll("circle")
          .data(unemp_data)
          .enter().append("circle")
          .attr('class', function(d){return 'country_object_' + d.id})
          .attr('clicked', 'false')
          .attr('type', 'main_scatter')
          .attr("r", function(d) { return r_unemp(d.chomage); })
          .attr("cx", function(d) { return x_unemp(d.pop); })
          .attr("cy", function(d) { return y_unemp(d.date); })
          .style("fill", function(d) { return color_scatter(d.pays); })
          .on("mouseover", function(d){return mouseover(d, Tooltip_unemp, this);})
          .on("mouseleave", function(d){return mouseleave(d, Tooltip_unemp, this);})
          .on("mousemove", function(d)
                            {
                              return mousemove(
                                                d, Tooltip_unemp, this,
                                                d.pays + "</br>Pourcentage d'émigrant: " +
                                                d3.format(".1f")(d.pop * 100 ) +
                                                "%</br>Chomage: " +
                                                d3.format(".1f")(d.chomage) + "%"
                                              );
                            }
              );

        svg_map_unemp.append('g')
          .attr('class', 'countries')
          .selectAll('path')
          .data(map_data.features)
          .enter().append('path')
            .attr('d', little_path)
            .style('fill', 'rgb(33, 113, 181)')
            .style('stroke', 'white')
            .style('opacity', 0.8)
            .style('stroke-width', 0.3)
            .attr('class', function(d){return 'country_object_' + d.id})
            .attr('type', 'little_map')
            .attr('clicked', 'false');
      }

      function update_top10(d, country, data=false, data_norm=false)
      {
        if (country.attr('clicked') == 'false')
        {
          d3.select('#top10container')
            .html('<h3>Cliquez sur un pays pour obtenir des informations</h3>');
          d3.select('#norm_top10container')
            .html('');
        }
        else
        {
          if (data !== false)
          {
            var data_length = Object.keys(data).length;
            if (data_length > 0)
            {
              var top10_html = '<h3>' + d.properties.name + ' : top ' +
                                data_length + ' des pays qui arrivent' +
                                ' plus massivement</h3><br/><table>';

              for (let i = 0; i < data_length; i++)
                top10_html += '<tr><td class="tdleft">' + data[i].origin + '</td><td class="tdright">' + integerFormat(data[i].migrant_stock) + '</td></tr>';

              top10_html += '</table>';
              d3.select('#top10container')
                .html(top10_html);
            }
            else
            {
              d3.select('#top10container')
                .html('<h3>' + d.properties.name +
                      ' : nous ne disposons pas des informations' +
                      ' sur les immigrants arrivants à ce pays pour' +
                      ' l\'année choisie</h3>'
                      );
            }
          }

          if (data_norm !== false)
          {
            var data_norm_length = Object.keys(data_norm).length;
            if (data_norm_length > 0)
            {
              var norm_top10_html = '<h3>' + d.properties.name + ' : top ' +
                                data_norm_length + ' des pays qui arrivent' +
                                ' plus massivement (pourcentage par' +
                                ' rapport à la population du pays' +
                                ' d\'arrivée)</h3><br/><table>';
              for (let i = 0; i < data_norm_length; i++)
              {
                norm_top10_html += '<tr><td class="tdleft">' + data_norm[i].origin + '</td><td class="tdright">' + percentageFormat(data_norm[i].migrant_stock / data_norm[i].pop_destination) + '</td></tr>';
              }

              norm_top10_html += '</table>';
              d3.select('#norm_top10container')
                .html(norm_top10_html);
            }
            else
            {
              d3.select('#norm_top10container')
                .html('<h3>' + d.properties.name +
                      ' : nous ne disposons pas des informations' +
                      ' sur les immigrants arrivants à ce pays pour' +
                      ' l\'année choisie</h3>'
                      )
            }
          }
        }
      }

      function raise_country(d, country, data, data_norm)
      {
        //data has the top10 of inmigrants arriving to country
        var current_element = d3.select(country);
        if (current_element.attr('clicked') == 'true')
        {
          little_projection
            .rotate([0, 0])
            .scale(75)
            .translate([width_little_map / 2, height_little_map / 2]);

          svg_map_hdi.selectAll("path")
            .transition()
            .duration(0)
            .attr("d", little_path);

          svg_map_gii.selectAll("path")
            .transition()
            .duration(0)
            .attr("d", little_path);

          svg_map_unemp.selectAll("path")
            .transition()
            .duration(0)
            .attr("d", little_path);

          d3.selectAll('*[class^=country_object_]')
              .each(function(d)
                    {
                      let country_element = d3.select(this);
                      let fill_colour,
                          opacity_intensity = 0.8,
                          clicked_value = 'false';

                      if (country_element.attr('type') == 'little_map' ||
                          country_element.attr('type') == 'main_map')
                        fill_colour = 'rgb(33, 113, 181)';
                      else if (country_element.attr('type') == 'main_scatter')
                        fill_colour = color_scatter(d.pays);

                      country_element
                        .style('fill', fill_colour)
                        .style("opacity", opacity_intensity)
                        .attr('clicked', clicked_value);
                    }
                  );
        }
        else
        {
          //change projection little maps
          let new_center = little_projection(
                                             [d.geometry.center.longitude,
                                              d.geometry.center.latitude]
                                            );
          little_projection
            .rotate(
                      [
                        - little_projection.invert(new_center)[0],
                        - little_projection.invert(new_center)[1]
                      ]
                    )
            .fitSize([width_little_map - 50, height_little_map - 50], d)
            .translate([width_little_map / 2, height_little_map / 2]);

          svg_map_hdi.selectAll("path")
            .transition()
            .duration(0)
            .attr("d", little_path);

          svg_map_gii.selectAll("path")
            .transition()
            .duration(0)
            .attr("d", little_path);

          svg_map_unemp.selectAll("path")
            .transition()
            .duration(0)
            .attr("d", little_path);

          d3.selectAll('*[class^=country_object_]')
              .each(function(d)
                    {
                      let country_element = d3.select(this);
                      let fill_colour,
                          opacity_intensity,
                          clicked_value;
                      if (country_element.attr('class') == current_element.attr('class'))
                      {
                        fill_colour = "#e00000";
                        opacity_intensity = 1;
                        clicked_value = 'true';
                        country_element.raise();
                      }
                      else
                      {
                        clicked_value = 'false';

                        if (country_element.attr('type') == 'little_map' ||
                            country_element.attr('type') == 'main_map')
                        {
                          fill_colour = 'rgb(33, 113, 181)';
                          opacity_intensity = 0.8;
                        }
                        else if (country_element.attr('type') == 'main_scatter')
                        {
                          fill_colour = color_scatter(d.pays);
                          opacity_intensity = 0.3;
                        }
                      }

                      country_element
                        .style('fill', fill_colour)
                        .style("opacity", opacity_intensity)
                        .attr('clicked', clicked_value);
                    }
                  );
        }
        update_top10(d, d3.select(country), data, data_norm);
        clicked_country =  d3.select(country);
      }

      function year_opacity(year, data, svg_image, stroke_function)
      {
        svg_image.selectAll(".countries_migrations").remove()

        svg_image.append('g')
          .attr('class', 'countries_migrations')
          .selectAll("path")
          .data(data)
          .enter()
          .append("path")
          .attr("d", function(d)
                      {
                        var x = {
                                  type: "LineString",
                                  coordinates : [[d.long_o, d.lat_o], [d.long_d, d.lat_d]]
                                };
                        return main_path(x);
                      }
                )
          .attr('name',  function(d){return d.origin + '_' + d.destination;})
          .style("fill", "none")
          .style("stroke", "#0e104b")
          .style("stroke-width", stroke_function);

      }
    </script>

  </body>

</html>
